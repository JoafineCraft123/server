<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>IDE Python Online Simples</title>
<style>
  body, html {
    margin:0; padding:0; height:100%;
    display:flex;
    flex-direction: column;
    font-family: monospace;
    background: #1e1e1e;
    color: #eee;
  }
  #tabs {
    display: flex;
    background: #252526;
    border-bottom: 2px solid #007acc;
    user-select:none;
  }
  .tab {
    padding: 10px 15px;
    cursor: pointer;
    border-right: 1px solid #444;
    background: #252526;
    color: #ccc;
  }
  .tab.active {
    background: #1e90ff;
    color: white;
    font-weight: bold;
  }
  .tab .close-btn {
    margin-left: 8px;
    color: #888;
    font-weight: bold;
    cursor: pointer;
  }
  .tab .close-btn:hover {
    color: red;
  }
  #new-file-btn {
    padding: 10px 15px;
    cursor: pointer;
    background: #0a84ff;
    color: white;
    font-weight: bold;
  }
  #editor-container, #terminal-container {
    flex-grow: 1;
    display: none;
    height: calc(100vh - 42px);
    background: #1e1e1e;
  }
  #editor-container.active, #terminal-container.active {
    display: block;
  }
  .CodeMirror {
    height: 100%;
    font-size: 14px;
    background: #1e1e1e;
    color: #eee;
  }
  #terminal-output {
    height: calc(100% - 35px);
    overflow-y: auto;
    padding: 10px;
    white-space: pre-wrap;
    background: #121212;
    color: #eee;
    font-family: monospace;
    font-size: 14px;
  }
  #terminal-input {
    width: 100%;
    border: none;
    outline: none;
    padding: 8px 10px;
    font-family: monospace;
    font-size: 14px;
    background: #1e1e1e;
    color: white;
    box-sizing: border-box;
  }
  #run-btn {
    position: absolute;
    top: 12px;
    right: 20px;
    padding: 6px 12px;
    background: #0a84ff;
    border: none;
    color: white;
    cursor: pointer;
    font-weight: bold;
    border-radius: 3px;
    user-select: none;
  }
</style>

<!-- CodeMirror 5 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.14/mode/python/python.min.js"></script>

<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

</head>
<body>

<div id="tabs">
  <div class="tab active" data-tab="main.py">main.py</div>
  <div class="tab" data-tab="cmd.exe">cmd.exe</div>
  <div id="new-file-btn">+ Novo Arquivo</div>
</div>

<div id="editor-container" class="active"></div>
<div id="terminal-container">
  <div id="terminal-output">(Terminal Python)</div>
  <input id="terminal-input" placeholder="Digite comando Python e Enter" autocomplete="off" />
</div>

<button id="run-btn" title="Rodar main.py">▶️ Rodar main.py</button>

<script>
  let pyodide = null;
  let editors = {};
  let files = {
    "main.py": "# Escreva seu código aqui\nprint('Olá do main.py!')"
  };
  let currentTab = "main.py";

  const tabsEl = document.getElementById("tabs");
  const editorContainer = document.getElementById("editor-container");
  const terminalContainer = document.getElementById("terminal-container");
  const termOutput = document.getElementById("terminal-output");
  const termInput = document.getElementById("terminal-input");
  const runBtn = document.getElementById("run-btn");
  const newFileBtn = document.getElementById("new-file-btn");

  function appendTerminal(text) {
    termOutput.textContent += text + "\n";
    termOutput.scrollTop = termOutput.scrollHeight;
  }

  async function initPyodide() {
    appendTerminal("Carregando Pyodide...");
    pyodide = await loadPyodide({
      indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
    });
    appendTerminal("Pyodide carregado.");
    await pyodide.loadPackage("micropip");
    appendTerminal("Pacote micropip carregado.");
    await pyodide.runPythonAsync(`
import sys
import io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
`);
  }

  function createEditorTab(filename) {
    if (!files[filename]) {
      files[filename] = "# Novo arquivo\n";
    }
    if (!editors[filename]) {
      const textarea = document.createElement("textarea");
      editorContainer.appendChild(textarea);
      const cm = CodeMirror.fromTextArea(textarea, {
        mode: "python",
        lineNumbers: true,
        theme: "default",
        viewportMargin: Infinity,
        extraKeys: {"Tab": "indentMore"}
      });
      cm.setValue(files[filename]);
      cm.getWrapperElement().style.height = "100%";
      cm.getWrapperElement().style.display = "none";
      editors[filename] = cm;
    }
  }

  function setActiveTab(tabName) {
    if (currentTab === tabName) return;

    // Salvar conteúdo da aba atual (se for editor)
    if (editors[currentTab]) {
      files[currentTab] = editors[currentTab].getValue();
    }

    currentTab = tabName;

    // Atualizar abas visuais
    [...tabsEl.querySelectorAll(".tab")].forEach(tab => {
      tab.classList.toggle("active", tab.dataset.tab === tabName);
    });

    // Mostrar editor ou terminal conforme aba
    if (tabName === "cmd.exe") {
      editorContainer.classList.remove("active");
      terminalContainer.classList.add("active");
      runBtn.style.display = "none";
      termInput.focus();
    } else {
      // Mostrar editor para o arquivo da aba
      editorContainer.classList.add("active");
      terminalContainer.classList.remove("active");
      runBtn.style.display = "inline-block";
      // Esconder todos os editors e mostrar só o atual
      for (const f in editors) {
        const dom = editors[f].getWrapperElement();
        dom.style.display = f === tabName ? "block" : "none";
        if(f === tabName) editors[f].focus();
      }
    }
  }

  function addTab(filename) {
    if (document.querySelector(`.tab[data-tab="${filename}"]`)) {
      setActiveTab(filename);
      return;
    }
    const tab = document.createElement("div");
    tab.className = "tab";
    tab.dataset.tab = filename;
    tab.textContent = filename;

    // botão fechar para novos arquivos (exceto main.py e cmd.exe)
    if(filename !== "main.py" && filename !== "cmd.exe") {
      const closeBtn = document.createElement("span");
      closeBtn.textContent = "×";
      closeBtn.className = "close-btn";
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        // salvar antes de fechar
        if(editors[filename]) {
          files[filename] = editors[filename].getValue();
          editors[filename].toTextArea();
          editors[filename].getWrapperElement().remove();
          delete editors[filename];
          delete files[filename];
        }
        tab.remove();
        // Se aba fechada era ativa, voltar para main.py
        if(currentTab === filename) setActiveTab("main.py");
      };
      tab.appendChild(closeBtn);
    }

    tab.onclick = () => {
      setActiveTab(filename);
    };

    tabsEl.insertBefore(tab, newFileBtn);
    createEditorTab(filename);
    setActiveTab(filename);
  }

  // Cria as abas iniciais
  addTab("main.py");
  addTab("cmd.exe");

  newFileBtn.onclick = () => {
    const nome = prompt("Nome do novo arquivo (ex: utils.py):");
    if (!nome) return;
    if(files[nome]) {
      alert("Arquivo já existe!");
      setActiveTab(nome);
      return;
    }
    files[nome] = "# Novo arquivo\n";
    addTab(nome);
  };

  runBtn.onclick = async () => {
    if(editors["main.py"]) files["main.py"] = editors["main.py"].getValue();

    appendTerminal(`>>> Rodando main.py ...`);
    try {
      await pyodide.runPythonAsync(`
import sys
import io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
`);

      for(let filename in files) {
        if(filename === "main.py") continue;
        let code = files[filename];
        await pyodide.runPythonAsync(`
exec("""${code.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n")}""")
`);
      }

      let output = await pyodide.runPythonAsync(files["main.py"]);
      let saida = pyodide.runPython("sys.stdout.getvalue()");
      if(!saida.trim() && output !== undefined) saida = output.toString();
      appendTerminal(saida || "(sem saída)");
    } catch(err) {
      appendTerminal("Erro: " + err);
    }
  };

  termInput.addEventListener("keydown", async (e) => {
    if(e.key === "Enter") {
      e.preventDefault();
      let cmd = termInput.value.trim();
      if(!cmd) return;
      appendTerminal(">>> " + cmd);
      termInput.value = "";
      try {
        await pyodide.runPythonAsync(`
import sys
import io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
`);
        let result = await pyodide.runPythonAsync(cmd);
        let saida = pyodide.runPython("sys.stdout.getvalue()");
        if(!saida.trim() && result !== undefined) saida = result.toString();
        appendTerminal(saida || "(sem saída)");
      } catch(err) {
        appendTerminal("Erro: " + err);
      }
    }
  });

  (async () => {
    await initPyodide();
  })();
</script>

</body>
</html>
