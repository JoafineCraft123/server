let pyodide = null;
let installedPackages = new Set();
const MAX_CODE_SIZE = 5000; // máximo de caracteres no código
const MAX_PACKAGES = 3;

async function loadPyodideEnv() {
  if (pyodide) await pyodide.terminate(); // libera memória
  pyodide = await loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"});
  installedPackages.clear();
}

async function runCode() {
  if (!pyodide) {
    alert("Python is still loading...");
    return;
  }
  const code = document.getElementById('editor').value;
  if(code.length > MAX_CODE_SIZE){
    alert(`Code too large! Max allowed is ${MAX_CODE_SIZE} characters.`);
    return;
  }
  try {
    pyodide.runPython(`
import sys
import io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
`);
    await pyodide.runPythonAsync(code);
    let output = pyodide.runPython("sys.stdout.getvalue()");
    document.getElementById('output').textContent = output || "(no output)";
  } catch(e) {
    document.getElementById('output').textContent = "Error:\n" + e;
  }
}

async function installPackage(pkgName) {
  if (!pyodide) {
    alert("Python is still loading...");
    return;
  }
  if(installedPackages.size >= MAX_PACKAGES){
    alert(`Package install limit reached! Max allowed is ${MAX_PACKAGES} packages per session.`);
    return;
  }
  if(!pkgName){
    alert("Enter a package name.");
    return;
  }
  try {
    await pyodide.loadPackage("micropip");
    await pyodide.runPythonAsync(`import micropip; await micropip.install('${pkgName}')`);
    installedPackages.add(pkgName);
    document.getElementById('output').textContent = `Package '${pkgName}' installed successfully!`;
  } catch(e) {
    document.getElementById('output').textContent = `Failed to install '${pkgName}':\n${e}`;
  }
}

async function resetPyodide() {
  if(pyodide) await pyodide.terminate();
  document.getElementById('output').textContent = "Resetting Python environment...";
  await loadPyodideEnv();
  document.getElementById('output').textContent = "Python environment reset.";
}

// Chame loadPyodideEnv() ao carregar a página

// Exemplo para vincular botões:
/*
document.getElementById('run-btn').onclick = runCode;
document.getElementById('install-btn').onclick = () => {
  const pkg = document.getElementById('package-input').value.trim();
  installPackage(pkg);
};
document.getElementById('reset-btn').onclick = resetPyodide;
*/
